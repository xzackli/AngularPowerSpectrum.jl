<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Covariance · PowerSpectra.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://xzackli.github.io/PowerSpectra.jl/covariance/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">PowerSpectra.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../quickstart/">Quickstart</a></li><li><a class="tocitem" href="../spectra/">Spectra</a></li><li class="is-active"><a class="tocitem" href>Covariance</a><ul class="internal"><li><a class="tocitem" href="#Computing-the-Covariance"><span>Computing the Covariance</span></a></li><li><a class="tocitem" href="#API"><span>API</span></a></li></ul></li><li><a class="tocitem" href="../beams/">Beams</a></li><li><a class="tocitem" href="../util/">Utilities</a></li><li><a class="tocitem" href="../module_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Covariance</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Covariance</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/xzackli/PowerSpectra.jl/blob/master/docs/src/covariance.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Covariance-Estimation"><a class="docs-heading-anchor" href="#Covariance-Estimation">Covariance Estimation</a><a id="Covariance-Estimation-1"></a><a class="docs-heading-anchor-permalink" href="#Covariance-Estimation" title="Permalink"></a></h1><p>The covariance between two spectra <span>$\textrm{Cov}(\hat{C}_{\ell}^{XY,i,j}, \hat{C}_{\ell}^{WZ,p,q})$</span> for channels <span>$X,Y,W,Z \in \{T, E\}$</span> obtained from masked maps can be expressed using</p><ul><li>spherical harmonic coefficients of the masks of the four maps <span>$i, j, p, q$</span> involved in the covariance</li><li>assumed signal spectrum <span>$C_{\ell,\mathrm{tot}}^{XY}$</span>, for example <span>$C_{\ell}^{\mathrm{th}} + C_{\ell}^{\mathrm{fg},i,j}$</span></li><li>pixel variance maps <span>$\sigma_p^{XX}$</span> for <span>$XX \in \{II, QQ, UU\}$</span> for the four maps involved in the covariance</li></ul><p>However, these are only sufficient for a description of a homogeneous survey with white noise and sufficient mask apodization. Two additional corrections are required for <span>$\sim1\%$</span> covariance determinations.</p><ul><li>noise power spectra <span>$\hat{N}_{\ell}^{XY,i,j}$</span> for the involved channels</li><li>corrections to the diagonals of the covariance matrices from insufficient apodization around point sources</li></ul><p>The basic calculation is essentially a mode-coupling calculation, and mode-coupling matrices are themselves used to correct the covariance matrix at the end. The methods in this package were written to match the analysis of the <em>Planck</em> satellite, and we provide a more detailed description of these methods in Li et al. 2020 (in prep). The derivation of these covariance matrices, in the limit of uniform noise, are available in Thibaut Louis&#39;s excellent <a href="https://pspy.readthedocs.io/en/latest/scientific_doc.pdf">notes</a>.</p><p>The expressions for the covariance matrix tend to reuse the same expressions many times, and one tends also to compute several different related covariance matrices (i.e. TTTT, TETE, TTTE) on the same maps. The covariance calculation in PowerSpectra.jl is centered around the <a href="#PowerSpectra.CovarianceWorkspace"><code>CovarianceWorkspace</code></a>, which caches the various quantities that are re-used during covariance estimation.</p><h2 id="Computing-the-Covariance"><a class="docs-heading-anchor" href="#Computing-the-Covariance">Computing the Covariance</a><a id="Computing-the-Covariance-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-Covariance" title="Permalink"></a></h2><p>First, let&#39;s set up the required data – masks and variances. The variance is a <a href="https://ziotom78.github.io/Healpix.jl/dev/mapfunc/#Healpix.PolarizedHealpixMap"><code>Healpix.PolarizedHealpixMap</code></a> containing the fields <code>i</code>, <code>q</code>, <code>u</code>. In this example, we read the masks from disk, but set the variances for everything to 1.</p><pre><code class="language-julia hljs">using Healpix, PowerSpectra
mask1_T = readMapFromFITS(&quot;test/data/mask1_T.fits&quot;, 1, Float64)
mask2_T = readMapFromFITS(&quot;test/data/mask2_T.fits&quot;, 1, Float64)
mask1_P = readMapFromFITS(&quot;test/data/mask1_T.fits&quot;, 1, Float64)
mask2_P = readMapFromFITS(&quot;test/data/mask2_T.fits&quot;, 1, Float64)

# for this example, pixel variance = 1
nside = mask1_T.resolution.nside
unit_var = PolarizedHealpixMap{Float64, RingOrder}(nside)
unit_var.i .= 1.0
unit_var.q .= 1.0
unit_var.u .= 1.0</code></pre><p>Once you have the masks and variances, you can create a <a href="#PowerSpectra.CovField"><code>CovField</code></a> for each field involved. This structure also has an associated name, which is used for the signal spectra.</p><pre><code class="language-julia hljs"># set up CovField, we&#39;re computing the variance of a spectrum on (f1 × f2)
f1 = CovField(&quot;143_hm1&quot;, mask1_T, mask1_P, unit_var)
f2 = CovField(&quot;143_hm2&quot;, mask2_T, mask2_P, unit_var)
f3 = f1
f4 = f2

# compute covariance between the (f1 × f2) spectrum and (f3 × f4) spectrum  
workspace = CovarianceWorkspace(f1, f2, f3, f4)</code></pre><p>A covariance matrix calculation needs an assumed signal spectrum for each channel you want.  You need to generate a dictionary that maps the names of various cross-spectra to <a href="../module_index/#PowerSpectra.SpectralVector-Tuple{AbstractVector}"><code>SpectralVector</code></a>.</p><pre><code class="language-julia hljs">cl_th = SpectralVector(ones(nside2lmax(nside)+1))

spectra = Dict{SpectrumName, SpectralVector{Float64, Vector{Float64}}}(
    (:TT, &quot;143_hm1&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:TT, &quot;143_hm1&quot;, &quot;143_hm2&quot;) =&gt; cl_th,
    (:TT, &quot;143_hm2&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:TT, &quot;143_hm2&quot;, &quot;143_hm2&quot;) =&gt; cl_th,

    (:EE, &quot;143_hm1&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:EE, &quot;143_hm1&quot;, &quot;143_hm2&quot;) =&gt; cl_th,
    (:EE, &quot;143_hm2&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:EE, &quot;143_hm2&quot;, &quot;143_hm2&quot;) =&gt; cl_th ,

    (:TE, &quot;143_hm1&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:TE, &quot;143_hm1&quot;, &quot;143_hm2&quot;) =&gt; cl_th,
    (:TE, &quot;143_hm2&quot;, &quot;143_hm1&quot;) =&gt; cl_th, (:TE, &quot;143_hm2&quot;, &quot;143_hm2&quot;) =&gt; cl_th)</code></pre><p>Now all that remains is to compute the coupled covmat.</p><pre><code class="language-julia hljs">C = coupledcov(:TT, :TT, workspace, spectra)</code></pre><h2 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="PowerSpectra.CovField" href="#PowerSpectra.CovField"><code>PowerSpectra.CovField</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">CovField(name, maskT, maskP,
    σ²II::HealpixMap{T, O, AA}, σ²QQ::HealpixMap{T, O, AA}, σ²UU::HealpixMap{T, O, AA},
    beamT::SpectralVector{T}, beamP::SpectralVector{T})</code></pre><p>Create a structure for describing the information needed for a covariance involving this field.</p><p><strong>Arguments:</strong></p><ul><li><code>name::String</code>: name of this field</li><li><code>maskT::HealpixMap{T}</code>: temperature mask</li><li><code>maskP::HealpixMap{T}</code>: polarization mask</li><li><code>σ²::PolarizedHealpixMap{T}</code>: pixel variances</li><li><code>beamT::SpectralVector{T}</code>: temperature beam</li><li><code>beamP::SpectralVector{T}</code>: polarization beam</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/xzackli/PowerSpectra.jl/blob/cd325f42f34892183a5dca64a070bb0c7e055254/src/workspace.jl#LL14-L29">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PowerSpectra.CovarianceWorkspace" href="#PowerSpectra.CovarianceWorkspace"><code>PowerSpectra.CovarianceWorkspace</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">CovarianceWorkspace(m_i, m_j, m_p, m_q; lmax::Int=0)</code></pre><p>Inputs and cache for covariance calculations. A covariance matrix relates the masks of four fields and spins. This structure caches various cross-spectra between masks and noise-weighted masks.</p><p><strong>Arguments:</strong></p><ul><li><code>m_i::CovField{T}</code>: map i</li><li><code>m_j::CovField{T}</code>: map j</li><li><code>m_p::CovField{T}</code>: map p</li><li><code>m_q::CovField{T}</code>: map q</li></ul><p><strong>Keywords</strong></p><ul><li><code>lmax::Int=0</code>: maximum multipole to compute covariance matrix</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/xzackli/PowerSpectra.jl/blob/cd325f42f34892183a5dca64a070bb0c7e055254/src/workspace.jl#LL83-L98">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="PowerSpectra.coupledcov" href="#PowerSpectra.coupledcov"><code>PowerSpectra.coupledcov</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">coupledcov(ch1, ch2, workspace, spectra;
           noiseratios=Dict(), lmax=0) where T</code></pre><p><strong>Arguments:</strong></p><ul><li><code>ch1::Symbol</code>: spectrum type of first spectrum (i.e. :TT, :TE, :EE)</li><li><code>ch2::Symbol</code>: spectrum type of second spectrum (i.e. :TT, :TE, :EE)</li><li><code>workspace</code>: cache for working with covariances</li><li><code>spectra</code>: signal spectra</li></ul><p><strong>Keywords</strong></p><ul><li><code>noiseratios::AbstractDict</code>: ratio of noise spectra to white noise</li><li><code>lmax=0</code>: maximum multipole moment for covariance matrix</li></ul><p><strong>Returns:</strong></p><ul><li><code>SpectralArray{T,2}</code>: covariance matrix (0-indexed)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/xzackli/PowerSpectra.jl/blob/cd325f42f34892183a5dca64a070bb0c7e055254/src/covariance.jl#LL17-L33">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../spectra/">« Spectra</a><a class="docs-footer-nextpage" href="../beams/">Beams »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Wednesday 15 December 2021 22:41">Wednesday 15 December 2021</span>. Using Julia version 1.7.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
